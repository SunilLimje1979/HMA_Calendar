{% load static %}
{% load pwa %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1, user-scalable=no">
    <title>New HMA Calendar</title>
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <link rel="shortcut icon" href="{% static 'images/HMALogo.png' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css"/>
    <style>
        /* CSS is unchanged */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #b0dcf5;
            overflow-x: hidden;
            position: relative;
        }
        .navbar {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            background-color: #005ba6 !important;
            max-width: 450px; 
            margin: 0 auto;   
            left: 0;
            right: 0;
        }
        .navbar-brand img {
            box-shadow: none;
        }
        .three-dot-menu {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 1.5em;
            color: white;
        }
        .about-us-text {
            display: none;
            position: absolute;
            top: 40px;
            right: 20px;
            background-color: #fff;
            padding: 5px 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            cursor: pointer;
        }
        .calendar-container {
            max-width: 450px;     
            margin: 70px auto 0; 
            position: relative;
        }
        .calendar-slider {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scrollbar-width: none;
        }
        .calendar-slider::-webkit-scrollbar {
            display: none;
        }
        .calendar-img-container {
            display: flex;
            flex-shrink: 0;
        }
        .calendar-img {
            flex-shrink: 0;
            scroll-snap-align: center;
        }
        #top-slider-front .calendar-img-container,
        #bottom-slider-front .calendar-img-container {
            gap: 10px; 
        }
        #top-slider-front .calendar-img,
        #bottom-slider-front .calendar-img {
            width: 100vw; 
            max-width: 450px; 
            height: 18vh;
            object-fit: cover;
            object-position: center; 
        }
        #middle-slider-front .calendar-img-container {
            display: flex;
            gap: 10px; 
        }
        #middle-slider-front {
            padding-left: 5px; 
        }
        #middle-slider-front .calendar-img {
            width: 95vw;
            max-width: calc(450px * 0.95);
            height: 58vh; 
            object-fit: contain;
            border-radius: 10px;
        }
        #middle-slider-back .calendar-img {
            width: 100vw;
            max-width: 450px;
            height: 65vh;
            object-fit: contain;
        }
        .toggle-icon {
            position: fixed;
            bottom: 40px;
            right: 30px;
            background-color: rgba(255, 255, 255, 0.975);
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .toggle-icon img.icon-img {
            width: 90%;
            height: 90%;
            object-fit: contain;
            padding: 10px;
        }
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%;
            height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.9);
            justify-content: center; align-items: center;
        }
        .modal-content {
            margin: auto; display: block; width: 95%; max-width: 1000px; max-height: 90vh;
        }
        .close-modal {
            position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px;
            font-weight: bold; cursor: pointer;
        }
        @keyframes infiniteScroll {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }
        .infinite-scroll .calendar-img-container {
            animation: infiniteScroll 40s linear infinite;
        }
        .infinite-scroll:hover .calendar-img-container,
        .infinite-scroll.paused .calendar-img-container {
            animation-play-state: paused;
        }
    </style>
</head>
<body>
    <!-- HTML Body is Unchanged -->
    <nav class="navbar fixed-top shadow-sm bg-white px-3 d-flex justify-content-between align-items-center">
        <div class="navbar-brand">
            <img src="{% static 'images/HMALogo.png' %}" alt="HMA Logo" style="width: 80px; height: auto; border-radius: 5px;">
        </div>
        <div class="three-dot-menu" id="three-dot-menu">
            <i class="fas fa-ellipsis-v"></i>
        </div>
        <div class="about-us-text" id="about-us-text">
            <a href="https://www.google.com/" target="_blank" style="text-decoration: none; color: inherit;">About Us</a>
        </div>
    </nav>
    <div class="calendar-container">
        <div id="top-slider-front" class="calendar-slider infinite-scroll">
            <div class="calendar-img-container">
                <img src="{% static 'images/newflow/JanTop1.jpeg' %}" class="calendar-img" data-month="1"><img src="{% static 'images/newflow/FebTop.jpeg' %}" class="calendar-img" data-month="2"><img src="{% static 'images/newflow/MarchTop.jpeg' %}" class="calendar-img" data-month="3"><img src="{% static 'images/newflow/AprilTop.jpeg' %}" class="calendar-img" data-month="4"><img src="{% static 'images/newflow/MayTop.jpeg' %}" class="calendar-img" data-month="5"><img src="{% static 'images/newflow/JuneTop.jpeg' %}" class="calendar-img" data-month="6"><img src="{% static 'images/newflow/JulyTop.jpeg' %}" class="calendar-img" data-month="7"><img src="{% static 'images/newflow/AugustTop.jpeg' %}" class="calendar-img" data-month="8"><img src="{% static 'images/newflow/SeptTop.jpeg' %}" class="calendar-img" data-month="9"><img src="{% static 'images/newflow/OctoberTop.jpeg' %}" class="calendar-img" data-month="10"><img src="{% static 'images/newflow/NovTop.jpeg' %}" class="calendar-img" data-month="11"><img src="{% static 'images/newflow/DecTop.jpeg' %}" class="calendar-img" data-month="12">
            </div>
        </div>
        <div id="middle-slider-front" class="calendar-slider">
            <div class="calendar-img-container">
                <img src="{% static 'images/newflow/January1.jpeg' %}" class="calendar-img zoomable" data-month="1"><img src="{% static 'images/newflow/Feb1.jpeg' %}" class="calendar-img zoomable" data-month="2"><img src="{% static 'images/newflow/March.jpeg' %}" class="calendar-img zoomable" data-month="3"><img src="{% static 'images/newflow/April.jpeg' %}" class="calendar-img zoomable" data-month="4"><img src="{% static 'images/newflow/May.jpeg' %}" class="calendar-img zoomable" data-month="5"><img src="{% static 'images/newflow/June.jpeg' %}" class="calendar-img zoomable" data-month="6"><img src="{% static 'images/newflow/July.jpeg' %}" class="calendar-img zoomable" data-month="7"><img src="{% static 'images/newflow/August.jpeg' %}" class="calendar-img zoomable" data-month="8"><img src="{% static 'images/newflow/Sept.jpeg' %}" class="calendar-img zoomable" data-month="9"><img src="{% static 'images/newflow/October.jpeg' %}" class="calendar-img zoomable" data-month="10"><img src="{% static 'images/newflow/Nov.jpeg' %}" class="calendar-img zoomable" data-month="11"><img src="{% static 'images/newflow/Dec.jpeg' %}" class="calendar-img zoomable" data-month="12">
            </div>
        </div>
        <div id="middle-slider-back" class="calendar-slider" style="display: none;">
            <div class="calendar-img-container">
                <img src="{% static 'images/January(Back Side).jpeg' %}" class="calendar-img zoomable" data-month="1"><img src="{% static 'images/Feb(Back Side).jpeg' %}" class="calendar-img zoomable" data-month="2"><img src="{% static 'images/March(Back Side).jpeg' %}" class="calendar-img zoomable" data-month="3"><img src="{% static 'images/April(Back Side).jpeg' %}" class="calendar-img zoomable" data-month="4"><img src="{% static 'images/May(Back Side).jpeg' %}" class="calendar-img" data-month="5"><img src="{% static 'images/June(Back Side).jpeg' %}" class="calendar-img" data-month="6"><img src="{% static 'images/July(Back Side).jpeg' %}" class="calendar-img" data-month="7"><img src="{% static 'images/August(Back Side).jpeg' %}" class="calendar-img" data-month="8"><img src="{% static 'images/Sept(Back Side).jpeg' %}" class="calendar-img" data-month="9"><img src="{% static 'images/Oct(Back Side).jpeg' %}" class="calendar-img" data-month="10"><img src="{% static 'images/Nov(Back Side).jpeg' %}" class="calendar-img" data-month="11"><img src="{% static 'images/Dec(Back Side).jpeg' %}" class="calendar-img" data-month="12">
            </div>
        </div>
        <div id="bottom-slider-front" class="calendar-slider infinite-scroll">
            <div class="calendar-img-container">
                <img src="{% static 'images/newflow/JanBottom.jpeg' %}" class="calendar-img" data-month="1"><img src="{% static 'images/newflow/FebBottom.jpeg' %}" class="calendar-img" data-month="2"><img src="{% static 'images/newflow/MarchBottom.jpeg' %}" class="calendar-img" data-month="3"><img src="{% static 'images/newflow/AprilBottom.jpeg' %}" class="calendar-img" data-month="4"><img src="{% static 'images/newflow/MayBottom.jpeg' %}" class="calendar-img" data-month="5"><img src="{% static 'images/newflow/JuneBottom.jpeg' %}" class="calendar-img" data-month="6"><img src="{% static 'images/newflow/JulyBottom.jpeg' %}" class="calendar-img" data-month="7"><img src="{% static 'images/newflow/AugustBottom.jpeg' %}" class="calendar-img" data-month="8"><img src="{% static 'images/newflow/SeptBottom.jpeg' %}" class="calendar-img" data-month="9"><img src="{% static 'images/newflow/OctoberBottom.jpeg' %}" class="calendar-img" data-month="10"><img src="{% static 'images/newflow/NovBottom.jpeg' %}" class="calendar-img" data-month="11"><img src="{% static 'images/newflow/DecBottom.jpeg' %}" class="calendar-img" data-month="12">
            </div>
        </div>
    </div>
    <div class="toggle-icon" id="toggle-icon">
        <img src="{% static 'images/Calendarturn.jpeg' %}" alt="Toggle Icon" class="icon-img">
    </div>
    <div id="imageModal" class="modal">
        <span class="close-modal" id="closeModal">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const topSlider = document.getElementById('top-slider-front');
            const middleSliderFront = document.getElementById('middle-slider-front');
            const middleSliderBack = document.getElementById('middle-slider-back');
            const bottomSlider = document.getElementById('bottom-slider-front');
            const toggleIcon = document.getElementById('toggle-icon');
            const modal = document.getElementById('imageModal');
            const initialMonthIndex = new Date().getMonth();
            let restartAutoplayTimer; 

            const scrollToMonth = (slider, monthIndex, behavior = 'smooth') => {
                const image = slider.querySelector(`.calendar-img:not(.clone)[data-month='${monthIndex + 1}']`);
                if (image) {
                    const scrollPos = image.offsetLeft - (slider.offsetWidth - image.offsetWidth) / 2;
                    slider.scrollTo({ left: scrollPos, behavior: behavior });
                }
            };
            
            const setupContinuousSlider = (slider) => {
                const container = slider.querySelector('.calendar-img-container');
                const images = Array.from(container.children);
                images.forEach(img => {
                    const clone = img.cloneNode(true);
                    clone.classList.add('clone');
                    container.appendChild(clone);
                });
            };

            const pauseAnimation = () => {
                topSlider.classList.add('paused');
                bottomSlider.classList.add('paused');
            };

            const resumeAnimation = () => {
                topSlider.classList.remove('paused');
                bottomSlider.classList.remove('paused');
            };
            
            // --- MODIFICATION: Separate handlers for different sliders ---
            const handleBannerInteraction = () => {
                pauseAnimation();
                clearTimeout(restartAutoplayTimer); 
                restartAutoplayTimer = setTimeout(resumeAnimation, 5000);
            };

            // Only top and bottom sliders pause the animation on touch
            [topSlider, bottomSlider].forEach(slider => {
                slider.addEventListener('touchstart', handleBannerInteraction, { passive: true });
            });
            
            const getVisibleMonthIndex = (slider) => {
                const sliderRect = slider.getBoundingClientRect();
                const sliderCenter = sliderRect.left + sliderRect.width / 2;
                let closestDist = Infinity;
                let visibleIndex = 0;
                slider.querySelectorAll('.calendar-img').forEach((img) => {
                    const imgRect = img.getBoundingClientRect();
                    const imgCenter = imgRect.left + imgRect.width / 2;
                    const dist = Math.abs(sliderCenter - imgCenter);
                    if (dist < closestDist) {
                        closestDist = dist;
                        visibleIndex = parseInt(img.dataset.month) - 1;
                    }
                });
                return visibleIndex;
            };

            toggleIcon.addEventListener('click', () => {
                const isFrontVisible = middleSliderFront.style.display !== 'none';
                const activeSlider = isFrontVisible ? middleSliderFront : middleSliderBack;
                const inactiveSlider = isFrontVisible ? middleSliderBack : middleSliderFront;
                const currentMonthIndex = getVisibleMonthIndex(activeSlider);
                activeSlider.style.opacity = '0';
                setTimeout(() => {
                    activeSlider.style.display = 'none';
                    inactiveSlider.style.display = 'flex';
                    scrollToMonth(inactiveSlider, currentMonthIndex, 'auto');
                    setTimeout(() => inactiveSlider.style.opacity = '1', 50);
                }, 300);
            });

            document.querySelectorAll('#top-slider-front .calendar-img, #bottom-slider-front .calendar-img').forEach(img => {
                img.addEventListener('click', (e) => {
                    if(e.target.classList.contains('clone')) return;
                    modal.style.display = 'flex';
                    document.getElementById('modalImage').src = e.target.src;
                    handleBannerInteraction();
                });
            });
            document.getElementById('closeModal').addEventListener('click', () => {
                modal.style.display = 'none';
                handleBannerInteraction();
            });
            document.getElementById('three-dot-menu').addEventListener('click', () => {
                const aboutUsText = document.getElementById('about-us-text');
                aboutUsText.style.display = (aboutUsText.style.display === 'block') ? 'none' : 'block';
            });
            
            window.addEventListener('load', () => {
                setupContinuousSlider(topSlider);
                setupContinuousSlider(bottomSlider);
                scrollToMonth(middleSliderFront, initialMonthIndex, 'auto');
            });

            // --- MODIFICATION: Full, working Zoom and Pan Logic restored ---
            document.querySelectorAll('.zoomable').forEach(img => {
                let initialDistance = 0, initialScale = 1, currentScale = 1;
                let isPanning = false, startX = 0, startY = 0;
                let offsetX = 0, offsetY = 0, lastOffsetX = 0, lastOffsetY = 0;
                let lastTap = 0;

                const disableScrolling = () => { document.body.style.overflow = 'hidden'; };
                const enableScrolling = () => { document.body.style.overflow = ''; };

                img.addEventListener('touchstart', (e) => {
                    handleBannerInteraction(); // Pause animation when interacting with zoomable image
                    if (e.touches.length === 2) {
                        isPanning = false; // Prevent panning during pinch
                        initialDistance = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                        initialScale = currentScale;
                    } else if (e.touches.length === 1 && currentScale > 1) {
                        isPanning = true;
                        startX = e.touches[0].pageX - lastOffsetX;
                        startY = e.touches[0].pageY - lastOffsetY;
                    }
                });

                img.addEventListener('touchmove', (e) => {
                    e.preventDefault(); // Prevent page scroll while zooming/panning
                    if (e.touches.length === 2) {
                        const newDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                        currentScale = Math.max(1, Math.min(initialScale * (newDist / initialDistance), 4));
                        img.style.transform = `scale(${currentScale}) translate(${offsetX}px, ${offsetY}px)`;
                        img.style.transition = 'none';
                        if (currentScale > 1) disableScrolling();
                    } else if (isPanning && e.touches.length === 1) {
                        offsetX = e.touches[0].pageX - startX;
                        offsetY = e.touches[0].pageY - startY;
                        img.style.transform = `scale(${currentScale}) translate(${offsetX}px, ${offsetY}px)`;
                    }
                });

                img.addEventListener('touchend', (e) => {
                    if (isPanning) {
                        lastOffsetX = offsetX;
                        lastOffsetY = offsetY;
                        isPanning = false;
                    }
                    if (currentScale <= 1) {
                        currentScale = 1;
                        offsetX = 0; offsetY = 0;
                        lastOffsetX = 0; lastOffsetY = 0;
                        img.style.transform = 'scale(1) translate(0, 0)';
                        img.style.transition = 'transform 0.3s ease';
                        enableScrolling();
                    }
                });

                // Double tap to reset zoom
                img.addEventListener('click', () => {
                    let currentTime = new Date().getTime();
                    if (currentTime - lastTap < 300) {
                        currentScale = 1;
                        offsetX = 0; offsetY = 0;
                        lastOffsetX = 0; lastOffsetY = 0;
                        img.style.transform = 'scale(1) translate(0, 0)';
                        img.style.transition = 'transform 0.3s ease';
                        enableScrolling();
                    }
                    lastTap = currentTime;
                });
            });
        });
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/cal2025/static/js/serviceworker.js')
                    .then(reg => console.log('Service Worker registered:', reg))
                    .catch(err => console.error('Service Worker registration failed:', err));
            });
        }
    </script>
</body>
</html>